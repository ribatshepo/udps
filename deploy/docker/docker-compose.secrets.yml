# Docker Compose secrets overlay for UDPS
# Usage: docker compose -f docker-compose.yml -f docker-compose.secrets.yml up -d
#
# Prerequisites:
#   1. Generate certificates: ../../scripts/generate-certs.sh
#   2. Create .env from .env.template and fill in credentials

services:
  udps:
    volumes:
      - ./certs/server.crt:/etc/udps/tls/server.crt:ro
      - ./certs/server.key:/etc/udps/tls/server.key:ro
      - ./certs/ca.crt:/etc/udps/tls/ca.crt:ro
    environment:
      - TLS_CERT_PATH=/etc/udps/tls/server.crt
      - TLS_KEY_PATH=/etc/udps/tls/server.key
      - TLS_CA_PATH=/etc/udps/tls/ca.crt
      - TLS_ENABLED=true

  postgres:
    volumes:
      - ./certs/server.crt:/var/lib/postgresql/server.crt:ro
      - ./certs/server.key:/var/lib/postgresql/server.key:ro
      - ./certs/ca.crt:/var/lib/postgresql/ca.crt:ro
    command: >
      postgres
        -c ssl=on
        -c ssl_cert_file=/var/lib/postgresql/server.crt
        -c ssl_key_file=/var/lib/postgresql/server.key
        -c ssl_ca_file=/var/lib/postgresql/ca.crt

  redis:
    volumes:
      - ./certs/server.crt:/etc/redis/tls/server.crt:ro
      - ./certs/server.key:/etc/redis/tls/server.key:ro
      - ./certs/ca.crt:/etc/redis/tls/ca.crt:ro
    command: >
      redis-server
        --tls-port 6380
        --port 6379
        --tls-cert-file /etc/redis/tls/server.crt
        --tls-key-file /etc/redis/tls/server.key
        --tls-ca-cert-file /etc/redis/tls/ca.crt
        --tls-auth-clients optional

  kafka:
    volumes:
      - ./certs/server.crt:/etc/kafka/tls/server.crt:ro
      - ./certs/server.key:/etc/kafka/tls/server.key:ro
      - ./certs/ca.crt:/etc/kafka/tls/ca.crt:ro
    environment:
      - KAFKA_SSL_KEYSTORE_LOCATION=/etc/kafka/tls/server.key
      - KAFKA_SSL_TRUSTSTORE_LOCATION=/etc/kafka/tls/ca.crt
      - KAFKA_SSL_KEY_PASSWORD=${KAFKA_SSL_KEY_PASSWORD:-}

  minio:
    volumes:
      - ./certs/server.crt:/root/.minio/certs/public.crt:ro
      - ./certs/server.key:/root/.minio/certs/private.key:ro
      - ./certs/ca.crt:/root/.minio/certs/CAs/ca.crt:ro
