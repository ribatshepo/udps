name: Weekly Security Scan

on:
  schedule:
    - cron: "0 6 * * 1"
  workflow_dispatch:

env:
  JDK_VERSION: "17"
  SBT_OPTS: "-Xmx2G -Xss2M"

jobs:
  dependency-audit:
    name: Dependency Vulnerability Audit
    runs-on: ubuntu-latest
    timeout-minutes: 20

    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JDK_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JDK_VERSION }}
          distribution: temurin

      - name: Cache SBT dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.sbt
            ~/.ivy2/cache
            ~/.cache/coursier
            target
            */target
          key: sbt-${{ runner.os }}-${{ hashFiles('**/*.sbt', 'project/Dependencies.scala', 'project/plugins.sbt', 'project/build.properties') }}
          restore-keys: |
            sbt-${{ runner.os }}-

      - name: Resolve all dependencies
        run: sbt -batch "update"

      - name: Run Trivy filesystem scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: fs
          scan-ref: .
          format: sarif
          output: trivy-fs-results.sarif
          severity: CRITICAL,HIGH,MEDIUM

      - name: Upload Trivy filesystem scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: trivy-fs-results.sarif
          category: trivy-filesystem

      - name: Run Trivy config scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: config
          scan-ref: .
          format: sarif
          output: trivy-config-results.sarif
          severity: CRITICAL,HIGH,MEDIUM

      - name: Upload Trivy config scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: trivy-config-results.sarif
          category: trivy-config

      - name: Run Trivy secret scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: fs
          scan-ref: .
          format: sarif
          output: trivy-secret-results.sarif
          scanners: secret

      - name: Upload Trivy secret scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: trivy-secret-results.sarif
          category: trivy-secrets

  docker-image-scan:
    name: Docker Image Vulnerability Scan
    runs-on: ubuntu-latest
    timeout-minutes: 20

    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to Docker registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.DOCKER_REGISTRY }}
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Scan latest Docker image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ secrets.DOCKER_REGISTRY }}/udps:latest
          format: sarif
          output: trivy-image-results.sarif
          severity: CRITICAL,HIGH,MEDIUM

      - name: Upload Docker image scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: trivy-image-results.sarif
          category: trivy-docker-image

  notify:
    name: Notify on Findings
    runs-on: ubuntu-latest
    needs: [dependency-audit, docker-image-scan]
    if: failure()

    steps:
      - name: Create GitHub Issue for security findings
        uses: actions/github-script@v7
        with:
          script: |
            const title = `Security Scan Findings - ${new Date().toISOString().split('T')[0]}`;
            const body = [
              '## Weekly Security Scan Report',
              '',
              'The scheduled security scan has detected findings that require attention.',
              '',
              `**Workflow Run:** [${context.runId}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`,
              '',
              '### Action Required',
              '- Review the Security tab for detailed SARIF results',
              '- Triage findings by severity (CRITICAL > HIGH > MEDIUM)',
              '- Update dependencies or apply mitigations as needed',
              '',
              '---',
              '*This issue was auto-generated by the weekly security scan workflow.*'
            ].join('\n');

            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'security,automated',
              state: 'open'
            });

            const duplicate = existingIssues.data.find(issue => issue.title.startsWith('Security Scan Findings'));
            if (duplicate) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: duplicate.number,
                body: `Updated scan on ${new Date().toISOString().split('T')[0]}:\n\n${body}`
              });
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['security', 'automated']
              });
            }
