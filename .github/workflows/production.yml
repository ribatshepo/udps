name: Production Pipeline

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*.*.*'

concurrency:
  group: production
  cancel-in-progress: false

permissions:
  contents: read

env:
  REGISTRY: docker.io
  IMAGE_NAME: seri-sa/udps

jobs:
  validate-version:
    name: Validate Version
    runs-on: ubuntu-latest
    timeout-minutes: 5

    outputs:
      version: ${{ steps.version.outputs.version }}
      major: ${{ steps.version.outputs.major }}
      minor: ${{ steps.version.outputs.minor }}
      patch: ${{ steps.version.outputs.patch }}

    steps:
      - name: Extract version from tag
        id: version
        run: |
          TAG="${GITHUB_REF#refs/tags/v}"
          if [[ ! "$TAG" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::Invalid version format: $TAG. Expected: X.Y.Z"
            exit 1
          fi

          MAJOR=$(echo "$TAG" | cut -d. -f1)
          MINOR=$(echo "$TAG" | cut -d. -f2)
          PATCH=$(echo "$TAG" | cut -d. -f3)

          echo "version=${TAG}" >> $GITHUB_OUTPUT
          echo "major=${MAJOR}" >> $GITHUB_OUTPUT
          echo "minor=${MINOR}" >> $GITHUB_OUTPUT
          echo "patch=${PATCH}" >> $GITHUB_OUTPUT

          echo "Version: ${TAG}"
          echo "Major: ${MAJOR}, Minor: ${MINOR}, Patch: ${PATCH}"

  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    needs: [validate-version]
    timeout-minutes: 30

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: udps_test
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: udps_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'sbt'

      - name: Compile
        run: sbt compile

      - name: Run tests with coverage
        env:
          POSTGRES_HOST: localhost
          POSTGRES_PORT: "5432"
          POSTGRES_DB: udps_test
          POSTGRES_USER: udps_test
          POSTGRES_PASSWORD: test_password
          REDIS_HOST: localhost
          REDIS_PORT: "6379"
        run: sbt coverage test coverageReport

      - name: Check coverage threshold (80%)
        run: |
          COVERAGE=$(grep -oP 'Statement coverage[^0-9]*\K[0-9.]+' target/scala-2.13/scoverage-report/scoverage.xml 2>/dev/null || echo "0")
          echo "Code coverage: ${COVERAGE}%"
          if (( $(echo "$COVERAGE < 80" | bc -l) )); then
            echo "::error::Code coverage ${COVERAGE}% is below 80% threshold required for production"
            exit 1
          fi
          echo "Coverage threshold met for production release"

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: target/scala-2.13/scoverage-report/scoverage.xml
          flags: production
          name: production-coverage
          fail_ci_if_error: true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            **/target/test-reports/
            **/target/scala-2.13/scoverage-report/
          retention-days: 90

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: [validate-version]
    timeout-minutes: 20
    permissions:
      security-events: write
      actions: read
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'sbt'

      - name: Run dependency vulnerability check
        run: sbt dependencyCheck

      - name: Run Trivy filesystem scan
        uses: aquasecurity/trivy-action@22438a435773de8c97dc0958cc0b823c45b064ac
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-fs-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'

      - name: Upload Trivy results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-fs-results.sarif'

  docker-build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [validate-version, build-and-test, security-scan]
    timeout-minutes: 30
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'sbt'

      - name: Build fat JAR
        run: sbt assembly

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=${{ needs.validate-version.outputs.version }}
            type=raw,value=${{ needs.validate-version.outputs.major }}.${{ needs.validate-version.outputs.minor }}
            type=raw,value=${{ needs.validate-version.outputs.major }}
            type=raw,value=latest
            type=raw,value=stable

      - name: Build and push
        id: docker-build
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILD_VERSION=${{ needs.validate-version.outputs.version }}
            BUILD_DATE=${{ github.event.head_commit.timestamp }}

      - name: Run Trivy container scan
        uses: aquasecurity/trivy-action@22438a435773de8c97dc0958cc0b823c45b064ac
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.validate-version.outputs.version }}
          format: 'sarif'
          output: 'trivy-container-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'

      - name: Upload Trivy container results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-container-results.sarif'

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3

      - name: Sign container image
        env:
          COSIGN_PRIVATE_KEY: ${{ secrets.COSIGN_PRIVATE_KEY }}
          COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}
        run: |
          cosign sign --yes --key env://COSIGN_PRIVATE_KEY \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.validate-version.outputs.version }}

          cosign sign --yes --key env://COSIGN_PRIVATE_KEY \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

          cosign sign --yes --key env://COSIGN_PRIVATE_KEY \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:stable

    outputs:
      image-tag: ${{ needs.validate-version.outputs.version }}
      image-digest: ${{ steps.docker-build.outputs.digest }}

  deploy-production:
    name: Deploy to Production (Blue-Green)
    runs-on: ubuntu-latest
    needs: [validate-version, docker-build]
    timeout-minutes: 30
    environment: production

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4

      - name: Configure kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG_PROD }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Determine deployment slot
        id: slot
        run: |
          CURRENT_SLOT=$(kubectl get service prod-udps -n seri-sa-platform -o jsonpath='{.spec.selector.slot}' 2>/dev/null || echo "blue")
          if [[ "$CURRENT_SLOT" == "blue" ]]; then
            NEW_SLOT="green"
          else
            NEW_SLOT="blue"
          fi
          echo "current=${CURRENT_SLOT}" >> $GITHUB_OUTPUT
          echo "new=${NEW_SLOT}" >> $GITHUB_OUTPUT
          echo "Current slot: ${CURRENT_SLOT}, New slot: ${NEW_SLOT}"

      - name: Deploy to new slot
        run: |
          cd deploy/kubernetes/overlays/production
          kustomize edit set image ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.docker-build.outputs.image-tag }}
          kubectl apply -k . -l slot=${{ steps.slot.outputs.new }}

      - name: Wait for new slot rollout
        run: |
          kubectl rollout status deployment/prod-udps-${{ steps.slot.outputs.new }} -n seri-sa-platform --timeout=300s

      - name: Health check new slot
        id: health-check
        run: |
          NEW_SLOT_IP=$(kubectl get service prod-udps-${{ steps.slot.outputs.new }} -n seri-sa-platform -o jsonpath='{.status.loadBalancer.ingress[0].ip}')

          for i in {1..30}; do
            if curl -sf "http://${NEW_SLOT_IP}:8081/health/ready"; then
              echo "Health check passed"
              exit 0
            fi
            echo "Waiting for health check... attempt $i"
            sleep 10
          done

          echo "::error::Health check failed after 30 attempts"
          exit 1

      - name: Switch traffic to new slot
        if: success()
        run: |
          kubectl patch service prod-udps -n seri-sa-platform -p "{\"spec\":{\"selector\":{\"slot\":\"${{ steps.slot.outputs.new }}\"}}}"
          echo "Traffic switched to ${{ steps.slot.outputs.new }} slot"

      - name: Verify production
        run: |
          sleep 10
          curl -sf "${{ vars.PROD_API_URL }}/health/ready" || exit 1
          echo "Production verification successful"

      - name: Rollback on failure
        if: failure()
        run: |
          echo "Deployment failed, keeping traffic on ${{ steps.slot.outputs.current }} slot"
          kubectl rollout undo deployment/prod-udps-${{ steps.slot.outputs.new }} -n seri-sa-platform || true

    outputs:
      deployed-slot: ${{ steps.slot.outputs.new }}
      previous-slot: ${{ steps.slot.outputs.current }}

  smoke-tests:
    name: Production Smoke Tests
    runs-on: ubuntu-latest
    needs: [deploy-production]
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run smoke tests
        env:
          UDPS_BASE_URL: ${{ vars.PROD_API_URL }}
        run: |
          chmod +x scripts/ci/smoke-tests.sh
          ./scripts/ci/smoke-tests.sh

  rollback-on-smoke-failure:
    name: Rollback on Smoke Failure
    runs-on: ubuntu-latest
    needs: [deploy-production, smoke-tests]
    if: failure() && needs.deploy-production.result == 'success'
    timeout-minutes: 10
    environment: production

    steps:
      - name: Configure kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG_PROD }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Rollback to previous slot
        run: |
          kubectl patch service prod-udps -n seri-sa-platform -p "{\"spec\":{\"selector\":{\"slot\":\"${{ needs.deploy-production.outputs.previous-slot }}\"}}}"
          echo "::warning::Rolled back to ${{ needs.deploy-production.outputs.previous-slot }} slot due to smoke test failure"

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [validate-version, docker-build, smoke-tests]
    timeout-minutes: 15
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate changelog
        id: changelog
        uses: mikepenz/release-changelog-builder-action@v4
        with:
          configuration: ".github/changelog-config.json"
          toTag: v${{ needs.validate-version.outputs.version }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b
        with:
          tag_name: v${{ needs.validate-version.outputs.version }}
          name: v${{ needs.validate-version.outputs.version }}
          body: |
            ## Docker Image

            ```bash
            docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.validate-version.outputs.version }}
            ```

            **Image Digest:** `${{ needs.docker-build.outputs.image-digest }}`

            **Available Tags:**
            - `${{ needs.validate-version.outputs.version }}`
            - `${{ needs.validate-version.outputs.major }}.${{ needs.validate-version.outputs.minor }}`
            - `${{ needs.validate-version.outputs.major }}`
            - `latest`
            - `stable`

            ## Changelog

            ${{ steps.changelog.outputs.changelog }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [validate-version, docker-build, deploy-production, smoke-tests, create-release]
    if: always()

    steps:
      - name: Determine status
        id: status
        run: |
          if [[ "${{ needs.smoke-tests.result }}" == "success" ]]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "emoji=:rocket:" >> $GITHUB_OUTPUT
            echo "message=Production deployment completed successfully" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "emoji=:x:" >> $GITHUB_OUTPUT
            echo "message=Production deployment failed" >> $GITHUB_OUTPUT
          fi

      - name: Send Slack notification
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "text": "UDPS Production Release v${{ needs.validate-version.outputs.version }}: ${{ steps.status.outputs.message }}",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "${{ steps.status.outputs.emoji }} UDPS Production Release v${{ needs.validate-version.outputs.version }}"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Status:*\n${{ steps.status.outputs.message }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Version:*\nv${{ needs.validate-version.outputs.version }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Image:*\n`${{ env.IMAGE_NAME }}:${{ needs.validate-version.outputs.version }}`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Deployed Slot:*\n${{ needs.deploy-production.outputs.deployed-slot }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "<${{ github.server_url }}/${{ github.repository }}/releases/tag/v${{ needs.validate-version.outputs.version }}|View Release> | <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
