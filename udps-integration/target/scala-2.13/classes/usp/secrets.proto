syntax = "proto3";

package usp.secrets;

import "google/protobuf/timestamp.proto";
import "usp/common.proto";

// Secrets Service - High-performance secrets access for service-to-service
service SecretsService {
  // Read secret from KV engine
  rpc GetSecret(GetSecretRequest) returns (GetSecretResponse);

  // Write secret to KV engine
  rpc PutSecret(PutSecretRequest) returns (PutSecretResponse);

  // Delete secret
  rpc DeleteSecret(DeleteSecretRequest) returns (usp.common.GrpcResponse);

  // List secrets in path
  rpc ListSecrets(ListSecretsRequest) returns (ListSecretsResponse);

  // Encrypt data (transit engine)
  rpc Encrypt(EncryptRequest) returns (EncryptResponse);

  // Decrypt data (transit engine)
  rpc Decrypt(DecryptRequest) returns (DecryptResponse);

  // Generate data key (for envelope encryption)
  rpc GenerateDataKey(GenerateDataKeyRequest) returns (GenerateDataKeyResponse);
}

// KV Engine operations
message GetSecretRequest {
  string path = 1;
  string workspace_id = 2;
  int32 version = 3; // 0 for latest
}

message GetSecretResponse {
  usp.common.GrpcResponse response = 1;
  map<string, string> data = 2;
  int32 version = 3;
  google.protobuf.Timestamp created_at = 4;
  string created_by = 5;
}

message PutSecretRequest {
  string path = 1;
  string workspace_id = 2;
  map<string, string> data = 3;
  map<string, string> metadata = 4;
}

message PutSecretResponse {
  usp.common.GrpcResponse response = 1;
  int32 version = 2;
  google.protobuf.Timestamp created_at = 3;
}

message DeleteSecretRequest {
  string path = 1;
  string workspace_id = 2;
  repeated int32 versions = 3; // Empty for all versions
}

message ListSecretsRequest {
  string path = 1;
  string workspace_id = 2;
}

message ListSecretsResponse {
  usp.common.GrpcResponse response = 1;
  repeated string keys = 2;
}

// Transit Engine operations
message EncryptRequest {
  string key_name = 1;
  string workspace_id = 2;
  bytes plaintext = 3;
  string context = 4; // Additional authenticated data
}

message EncryptResponse {
  usp.common.GrpcResponse response = 1;
  string ciphertext = 2;
  int32 key_version = 3;
}

message DecryptRequest {
  string key_name = 1;
  string workspace_id = 2;
  string ciphertext = 3;
  string context = 4;
}

message DecryptResponse {
  usp.common.GrpcResponse response = 1;
  bytes plaintext = 2;
}

message GenerateDataKeyRequest {
  string key_name = 1;
  string workspace_id = 2;
  int32 bits = 3; // 256 or 512
}

message GenerateDataKeyResponse {
  usp.common.GrpcResponse response = 1;
  bytes plaintext_key = 2;
  string ciphertext_key = 3;
  int32 key_version = 4;
}
